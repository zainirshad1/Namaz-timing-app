<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Namaz Times</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
        }
        /* Custom styling for form elements */
        .form-input {
            @apply w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-green-500 focus:border-transparent;
        }
        .form-label {
            @apply block text-gray-700 text-sm font-bold mb-2;
        }
        .admin-section {
            @apply bg-white p-6 rounded-lg shadow-md mb-8;
        }
        .admin-button {
            @apply bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition duration-200 ease-in-out;
        }
        .danger-button {
            @apply bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition duration-200 ease-in-out;
        }
        /* Table specific styles */
        .admin-table {
            @apply w-full border-collapse;
        }
        .admin-table th, .admin-table td {
            @apply p-3 border border-gray-200 text-left;
        }
        .admin-table th {
            @apply bg-gray-100 font-semibold text-gray-700;
        }
        .admin-table input[type="text"],
        .admin-table input[type="tel"],
        .admin-table input[type="email"],
        .admin-table input[type="number"],
        .admin-table input[type="time"] {
            @apply w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div class="bg-green-700 text-white py-4 px-6 flex justify-between items-center rounded-b-3xl shadow-lg">
        <h1 class="text-2xl font-bold">Admin Panel</h1>
        <div class="flex items-center space-x-4">
            <span id="user-display" class="text-green-100">Loading user...</span>
            <button id="logout-btn" class="bg-green-600 hover:bg-green-800 text-white px-4 py-2 rounded-lg">Logout</button>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 flex-1">
        <div id="auth-status-message" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 hidden" role="alert">
            <p class="font-bold">Authentication Required</p>
            <p>Please <a href="login.html" class="text-yellow-800 underline hover:text-yellow-900">log in</a> to access the admin panel.</p>
        </div>
        <div id="permission-denied-message" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 hidden" role="alert">
            <p class="font-bold">Permission Denied</p>
            <p>You do not have the necessary permissions to access this panel or perform this action.</p>
        </div>
        <div id="loading-message" class="text-center text-gray-500 hidden">Loading admin panel...</div>
        <div id="success-message" class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6 hidden" role="alert"></div>
        <div id="error-message" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 hidden" role="alert"></div>

        <!-- Super Admin Panel -->
        <div id="super-admin-panel" class="hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Super Admin Dashboard</h2>

            <!-- Advanced Filtering and Masjid Selection -->
            <div class="admin-section">
                <h3 class="text-lg font-medium text-gray-700 mb-4">Filter & Select Masjid</h3>
                
                <label for="filter-state" class="form-label">State:</label>
                <select id="filter-state" class="form-input">
                    <option value="">All States</option>
                </select>

                <label for="filter-city" class="form-label">City:</label>
                <select id="filter-city" class="form-input" disabled>
                    <option value="">All Cities</option>
                </select>

                <label for="filter-area" class="form-label">Area:</label>
                <select id="filter-area" class="form-input" disabled>
                    <option value="">All Areas</option>
                </select>

                <label for="select-masjid-super" class="form-label">Search or Select Masjid:</label>
                <input type="text" id="select-masjid-super" class="form-input" list="masjid-list-options" placeholder="Type to search or select a masjid...">
                <datalist id="masjid-list-options"></datalist>
                
                <div class="flex space-x-2 mt-4">
                    <button id="add-new-masjid-btn" class="admin-button bg-blue-600 hover:bg-blue-700">Add New Masjid</button>
                    <button id="clear-filters-btn" class="admin-button bg-gray-500 hover:bg-gray-600">Clear Filters</button>
                </div>
            </div>

            <!-- Consolidated Masjid Details Form -->
            <div id="masjid-details-section" class="admin-section hidden">
                <h3 class="text-lg font-medium text-gray-700 mb-4" id="masjid-details-header">Masjid Details</h3>
                <form id="masjid-details-form">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th colspan="2">Masjid Information</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="masjid-id-row">
                                <td><label for="masjid-id">Masjid ID (Unique):</label></td>
                                <td><input type="text" id="masjid-id" required></td>
                            </tr>
                            <tr>
                                <td><label for="masjid-name">Masjid Name:</label></td>
                                <td><input type="text" id="masjid-name" required></td>
                            </tr>
                            <tr>
                                <td><label for="masjid-contact">Contact Number:</label></td>
                                <td><input type="tel" id="masjid-contact"></td>
                            </tr>
                            <tr>
                                <td><label for="masjid-email">Email:</label></td>
                                <td><input type="email" id="masjid-email"></td>
                            </tr>
                            <tr>
                                <td><label for="masjid-address">Address:</label></td>
                                <td><input type="text" id="masjid-address"></td>
                            </tr>
                            <tr>
                                <td><label for="masjid-area">Area:</label></td>
                                <td><input type="text" id="masjid-area"></td>
                            </tr>
                            <tr>
                                <td><label for="masjid-zipcode">Zipcode:</label></td>
                                <td><input type="text" id="masjid-zipcode"></td>
                            </tr>
                            <tr>
                                <td><label for="masjid-city">City:</label></td>
                                <td><input type="text" id="masjid-city"></td>
                            </tr>
                            <tr>
                                <td><label for="masjid-state">State:</label></td>
                                <td><input type="text" id="masjid-state"></td>
                            </tr>
                            <tr>
                                <td><label for="masjid-country">Country:</label></td>
                                <td><input type="text" id="masjid-country"></td>
                            </tr>
                            <tr>
                                <td><label for="masjid-latitude">Latitude:</label></td>
                                <td><input type="number" step="any" id="masjid-latitude"></td>
                            </tr>
                            <tr>
                                <td><label for="masjid-longitude">Longitude:</label></td>
                                <td><input type="number" step="any" id="masjid-longitude"></td>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </div>

            <!-- Consolidated Prayer Times Form -->
            <div id="prayer-times-section" class="admin-section hidden">
                <h3 class="text-lg font-medium text-gray-700 mb-4">Prayer Times</h3>
                <form id="prayer-times-form">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Prayer Name</th>
                                <th>Azan</th>
                                <th>Prayer</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Fajr</td>
                                <td><input type="time" id="fajr-azan"></td>
                                <td><input type="time" id="fajr-prayer"></td>
                            </tr>
                            <tr>
                                <td>Dhuhr</td>
                                <td><input type="time" id="dhuhr-azan"></td>
                                <td><input type="time" id="dhuhr-prayer"></td>
                            </tr>
                            <tr>
                                <td>Asr</td>
                                <td><input type="time" id="asr-azan"></td>
                                <td><input type="time" id="asr-prayer"></td>
                            </tr>
                            <tr>
                                <td>Maghrib</td>
                                <td><input type="time" id="maghrib-azan"></td>
                                <td><input type="time" id="maghrib-prayer"></td>
                            </tr>
                            <tr>
                                <td>Isha</td>
                                <td><input type="time" id="isha-azan"></td>
                                <td><input type="time" id="isha-prayer"></td>
                            </tr>
                            <tr>
                                <td>Jumuah</td>
                                <td><input type="time" id="jumuah-azan"></td>
                                <td><input type="time" id="jumuah-prayer"></td>
                            </tr>
                        </tbody>
                    </table>
                </form>
                <div class="flex space-x-2 mt-4">
                    <button id="save-all-changes-btn" class="admin-button">Save All Changes</button>
                    <button type="button" class="danger-button" onclick="masjidDetailsForm.reset(); prayerTimesForm.reset(); selectedMasjidIdForEdit = null; toggleMasjidIdInput(true); clearAndHideMasjidForms();">Reset All Forms</button>
                </div>
            </div>
        </div>

        <!-- Masjid Admin Panel -->
        <div id="masjid-admin-panel" class="hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Masjid Admin Dashboard for <span id="managed-masjid-name" class="text-green-700"></span></h2>
            <!-- Edit Masjid Details Form -->
            <div class="admin-section">
                <h3 class="text-lg font-medium text-gray-700 mb-4">Edit Masjid Details</h3>
                <form id="edit-masjid-details-form-masjid-admin"> <!-- Renamed ID to avoid conflict -->
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th colspan="2">Masjid Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><label for="edit-masjid-name-ma">Masjid Name:</label></td>
                                <td><input type="text" id="edit-masjid-name-ma" required></td>
                            </tr>
                            <tr>
                                <td><label for="edit-masjid-contact-ma">Contact Number:</label></td>
                                <td><input type="tel" id="edit-masjid-contact-ma"></td>
                            </tr>
                            <tr>
                                <td><label for="edit-masjid-email-ma">Email:</label></td>
                                <td><input type="email" id="edit-masjid-email-ma"></td>
                            </tr>
                            <tr>
                                <td><label for="edit-masjid-address-ma">Address:</label></td>
                                <td><input type="text" id="edit-masjid-address-ma"></td>
                            </tr>
                            <tr>
                                <td><label for="edit-masjid-area-ma">Area:</label></td>
                                <td><input type="text" id="edit-masjid-area-ma"></td>
                            </tr>
                            <tr>
                                <td><label for="edit-masjid-zipcode-ma">Zipcode:</label></td>
                                <td><input type="text" id="edit-masjid-zipcode-ma"></td>
                            </tr>
                            <tr>
                                <td><label for="edit-masjid-city-ma">City:</label></td>
                                <td><input type="text" id="edit-masjid-city-ma"></td>
                            </tr>
                            <tr>
                                <td><label for="edit-masjid-state-ma">State:</label></td>
                                <td><input type="text" id="edit-masjid-state-ma"></td>
                            </tr>
                            <tr>
                                <td><label for="edit-masjid-country-ma">Country:</label></td>
                                <td><input type="text" id="edit-masjid-country-ma"></td>
                            </tr>
                            <tr>
                                <td><label for="edit-masjid-latitude-ma">Latitude:</label></td>
                                <td><input type="number" step="any" id="edit-masjid-latitude-ma"></td>
                            </tr>
                            <tr>
                                <td><label for="edit-masjid-longitude-ma">Longitude:</label></td>
                                <td><input type="number" step="any" id="edit-masjid-longitude-ma"></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="submit" class="admin-button mt-4">Save Masjid Details</button>
                    <button type="button" class="danger-button mt-4 ml-2" onclick="document.getElementById('edit-masjid-details-form-masjid-admin').reset()">Reset</button>
                </form>
            </div>

            <!-- Edit Prayer Times Form -->
            <div class="admin-section">
                <h3 class="text-lg font-medium text-gray-700 mb-4">Edit Prayer Times</h3>
                <form id="edit-prayer-times-form-masjid-admin"> <!-- Renamed ID to avoid conflict -->
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Prayer Name</th>
                                <th>Azan</th>
                                <th>Prayer</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Fajr</td>
                                <td><input type="time" id="fajr-azan-ma"></td>
                                <td><input type="time" id="fajr-prayer-ma"></td>
                            </tr>
                            <tr>
                                <td>Dhuhr</td>
                                <td><input type="time" id="dhuhr-azan-ma"></td>
                                <td><input type="time" id="dhuhr-prayer-ma"></td>
                            </tr>
                            <tr>
                                <td>Asr</td>
                                <td><input type="time" id="asr-azan-ma"></td>
                                <td><input type="time" id="asr-prayer-ma"></td>
                            </tr>
                            <tr>
                                <td>Maghrib</td>
                                <td><input type="time" id="maghrib-azan-ma"></td>
                                <td><input type="time" id="maghrib-prayer-ma"></td>
                            </tr>
                            <tr>
                                <td>Isha</td>
                                <td><input type="time" id="isha-azan-ma"></td>
                                <td><input type="time" id="isha-prayer-ma"></td>
                            </tr>
                            <tr>
                                <td>Jumuah</td>
                                <td><input type="time" id="jumuah-azan-ma"></td>
                                <td><input type="time" id="jumuah-prayer-ma"></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="submit" class="admin-button mt-4">Save Prayer Times</button>
                    <button type="button" class="danger-button mt-4 ml-2" onclick="document.getElementById('edit-prayer-times-form-masjid-admin').reset()">Reset</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhPYAh6wrTzlIdDPmomsFWDOquKlyG6Pk",
            authDomain: "namaz-times-app.firebaseapp.com",
            projectId: "namaz-times-app",
            storageBucket: "namaz-times-app.firebasestorage.app",
            messagingSenderId: "974582220585",
            appId: "1:974582220585:web:092a933942836566f95938",
            measurementId: "G-3CTLSN6BLS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const authStatusMessage = document.getElementById('auth-status-message');
        const permissionDeniedMessage = document.getElementById('permission-denied-message');
        const loadingMessage = document.getElementById('loading-message');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');

        const superAdminPanel = document.getElementById('super-admin-panel');
        const masjidAdminPanel = document.getElementById('masjid-admin-panel');
        const managedMasjidNameSpan = document.getElementById('managed-masjid-name');

        // Super Admin Elements (Consolidated & Filtered)
        const filterState = document.getElementById('filter-state');
        const filterCity = document.getElementById('filter-city');
        const filterArea = document.getElementById('filter-area');
        const selectMasjidSuper = document.getElementById('select-masjid-super'); // Now the input for datalist
        const masjidListOptions = document.getElementById('masjid-list-options'); // The datalist element
        const addNewMasjidBtn = document.getElementById('add-new-masjid-btn'); // New button for adding
        const clearFiltersBtn = document.getElementById('clear-filters-btn'); // New clear filters button
        const saveAllChangesBtn = document.getElementById('save-all-changes-btn'); // New consolidated save button

        // Consolidated Masjid Details Form Elements
        const masjidDetailsSection = document.getElementById('masjid-details-section');
        const masjidDetailsHeader = document.getElementById('masjid-details-header');
        const masjidDetailsForm = document.getElementById('masjid-details-form');
        const masjidIdInput = document.getElementById('masjid-id');
        const masjidIdRow = document.getElementById('masjid-id-row'); // To hide/show masjid ID row

        // Consolidated Prayer Times Form Elements
        const prayerTimesSection = document.getElementById('prayer-times-section');
        const prayerTimesForm = document.getElementById('prayer-times-form');

        // Masjid Admin Specific Forms (IDs renamed to avoid conflict with Super Admin's consolidated forms)
        const masjidAdminMasjidDetailsForm = document.getElementById('edit-masjid-details-form-masjid-admin');
        const masjidAdminPrayerTimesForm = document.getElementById('edit-prayer-times-form-masjid-admin');


        let currentUserRole = null;
        let currentUserMasjidId = null;
        let selectedMasjidIdForEdit = null; // null means 'add new', a string means 'edit existing'
        let allMasjidsData = []; // To store all masjids for search functionality

        // --- Helper Functions for UI Messages ---
        function showMessage(element, message, type = 'success') {
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            element.textContent = message;
            element.classList.remove('hidden');
            if (type === 'success') {
                element.classList.remove('bg-red-100', 'border-red-500', 'text-red-700');
                element.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
            } else { // 'error'
                element.classList.remove('bg-green-100', 'border-green-500', 'text-green-700');
                element.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            }
            // Hide after 5 seconds
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        function hideAllMessages() {
            authStatusMessage.classList.add('hidden');
            permissionDeniedMessage.classList.add('hidden');
            loadingMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        function showLoading() {
            hideAllMessages();
            loadingMessage.classList.remove('hidden');
        }

        function hideLoading() {
            loadingMessage.classList.add('hidden');
        }

        // --- Data Fetching Functions ---
        async function fetchUserRoleAndMasjidId(uid) {
            try {
                const userDocRef = doc(db, 'users', uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    console.log("DEBUG: Fetched user data from Firestore:", userData);
                    currentUserRole = userData.role || 'appUser';
                    currentUserMasjidId = userData.masjidId || null;
                    userDisplay.textContent = `Logged in as: ${userData.email} (${currentUserRole})`;
                    console.log("DEBUG: Assigned currentUserRole:", currentUserRole);
                    console.log("DEBUG: Assigned currentUserMasjidId:", currentUserMasjidId);
                } else {
                    console.log("DEBUG: User document NOT found for UID:", uid);
                    currentUserRole = 'appUser'; // Default if user doc not found
                    userDisplay.textContent = `Logged in as: ${auth.currentUser.email} (appUser)`;
                    showMessage(errorMessage, 'User profile not found in Firestore. Defaulting to appUser role.', 'error');
                }
            } catch (error) {
                console.error("Error fetching user role:", error);
                showMessage(errorMessage, 'Failed to fetch user role. Please try again.', 'error');
                currentUserRole = 'appUser'; // Fallback
                userDisplay.textContent = `Logged in as: ${auth.currentUser.email} (appUser)`;
            }
        }

        async function fetchAllMasjids() {
            try {
                const querySnapshot = await getDocs(collection(db, 'masjids'));
                return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error fetching all masjids:", error);
                showMessage(errorMessage, 'Failed to load masjids for selection.', 'error');
                return [];
            }
        }

        async function fetchMasjidDetails(masjidId) {
            try {
                const docRef = doc(db, 'masjids', masjidId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return { id: docSnap.id, ...docSnap.data() };
                } else {
                    showMessage(errorMessage, `Masjid with ID ${masjidId} not found.`, 'error');
                    return null;
                }
            }
            catch (error) {
                console.error(`Error fetching masjid details for ${masjidId}:`, error);
                showMessage(errorMessage, `Failed to load details for ${masjidId}.`, 'error');
                return null;
            }
        }

        async function fetchPrayerTimes(masjidId) {
            try {
                const docRef = doc(db, 'prayerTimes', masjidId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    showMessage(errorMessage, `Prayer times for masjid ID ${masjidId} not found.`, 'error');
                    return null;
                }
            } catch (error) {
                console.error(`Error fetching prayer times for ${masjidId}:`, error);
                showMessage(errorMessage, `Failed to load prayer times for ${masjidId}.`, 'error');
                return null;
            }
        }

        // Function to populate the State dropdown
        function populateStates() {
            const states = [...new Set(allMasjidsData.map(m => m.state).filter(Boolean))].sort();
            filterState.innerHTML = '<option value="">All States</option>';
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                filterState.appendChild(option);
            });
        }

        // Function to filter and populate City dropdown
        function filterCities() {
            const selectedState = filterState.value;
            filterCity.innerHTML = '<option value="">All Cities</option>';
            filterCity.disabled = !selectedState;
            filterArea.innerHTML = '<option value="">All Areas</option>';
            filterArea.disabled = true;
            selectMasjidSuper.value = ''; // Clear masjid selection

            let cities = [];
            if (selectedState) {
                cities = [...new Set(allMasjidsData
                    .filter(m => m.state === selectedState)
                    .map(m => m.city).filter(Boolean))].sort();
            }
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                filterCity.appendChild(option);
            });
            filterMasjids(); // Re-filter masjids based on new city list
        }

        // Function to filter and populate Area dropdown
        function filterAreas() {
            const selectedState = filterState.value;
            const selectedCity = filterCity.value;
            filterArea.innerHTML = '<option value="">All Areas</option>';
            filterArea.disabled = !selectedCity;
            selectMasjidSuper.value = ''; // Clear masjid selection

            let areas = [];
            if (selectedState && selectedCity) {
                areas = [...new Set(allMasjidsData
                    .filter(m => m.state === selectedState && m.city === selectedCity)
                    .map(m => m.area).filter(Boolean))].sort();
            }
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                filterArea.appendChild(option);
            });
            filterMasjids(); // Re-filter masjids based on new area list
        }

        // Function to filter and populate Masjid Datalist
        function filterMasjids() {
            const selectedState = filterState.value;
            const selectedCity = filterCity.value;
            const selectedArea = filterArea.value;

            let filteredMasjids = allMasjidsData;

            if (selectedState) {
                filteredMasjids = filteredMasjids.filter(m => m.state === selectedState);
            }
            if (selectedCity) {
                filteredMasjids = filteredMasjids.filter(m => m.city === selectedCity);
            }
            if (selectedArea) {
                filteredMasjids = filteredMasjids.filter(m => m.area === selectedArea);
            }
            
            populateMasjidDatalist(filteredMasjids);
            // Clear current selection and forms if filters change
            selectMasjidSuper.value = '';
            clearAndHideMasjidForms();
        }

        // Function to populate the masjid datalist
        function populateMasjidDatalist(masjidsToDisplay) {
            masjidListOptions.innerHTML = ''; // Clear existing options
            masjidsToDisplay.forEach(masjid => {
                const option = document.createElement('option');
                option.value = masjid.name; // Display name in input
                option.dataset.masjidId = masjid.id; // Store ID in dataset
                masjidListOptions.appendChild(option);
            });
        }

        // Function to clear and hide consolidated forms
        function clearAndHideMasjidForms() {
            masjidDetailsForm.reset();
            prayerTimesForm.reset();
            masjidDetailsSection.classList.add('hidden');
            prayerTimesSection.classList.add('hidden');
            selectedMasjidIdForEdit = null; // Reset for new entry
            toggleMasjidIdInput(true); // Ensure Masjid ID is editable for new entry
            masjidDetailsHeader.textContent = 'Masjid Details'; // Reset header
        }

        // Function to toggle Masjid ID input readonly state
        function toggleMasjidIdInput(isEditable) {
            masjidIdInput.readOnly = !isEditable;
            masjidIdInput.classList.toggle('bg-gray-100', !isEditable);
            masjidIdInput.classList.toggle('cursor-not-allowed', !isEditable);
        }

        // --- UI Rendering Functions ---
        async function renderSuperAdminPanel() {
            superAdminPanel.classList.remove('hidden');
            masjidAdminPanel.classList.add('hidden');
            hideLoading();

            // Fetch all masjids and store them
            allMasjidsData = await fetchAllMasjids();
            populateStates(); // Populate states first
            filterCities(); // Then cities based on state (or all if no state selected)
            filterAreas(); // Then areas based on city (or all if no city selected)
            populateMasjidDatalist(allMasjidsData); // Populate datalist with all masjids initially

            // Initially hide the consolidated forms
            clearAndHideMasjidForms();
        }

        async function renderMasjidAdminPanel() {
            superAdminPanel.classList.add('hidden');
            masjidAdminPanel.classList.remove('hidden');
            hideLoading();

            if (!currentUserMasjidId) {
                showMessage(errorMessage, "Your admin account is not linked to a specific masjid. Please contact super admin.", 'error');
                masjidAdminPanel.innerHTML = '<p class="text-red-700">No masjid linked to this admin account.</p>';
                return;
            }

            // Load details for the bonded masjid
            const masjidDetails = await fetchMasjidDetails(currentUserMasjidId);
            const prayerTimes = await fetchPrayerTimes(currentUserMasjidId);

            if (masjidDetails) {
                managedMasjidNameSpan.textContent = masjidDetails.name;
                // Populate Masjid Details Form for Masjid Admin
                document.getElementById('edit-masjid-name-ma').value = masjidDetails.name || '';
                document.getElementById('edit-masjid-contact-ma').value = masjidDetails.contactNumber || '';
                document.getElementById('edit-masjid-email-ma').value = masjidDetails.email || '';
                document.getElementById('edit-masjid-address-ma').value = masjidDetails.address || '';
                document.getElementById('edit-masjid-area-ma').value = masjidDetails.area || '';
                document.getElementById('edit-masjid-zipcode-ma').value = masjidDetails.zipcode || '';
                document.getElementById('edit-masjid-city-ma').value = masjidDetails.city || '';
                document.getElementById('edit-masjid-state-ma').value = masjidDetails.state || ''; // Added state for masjid admin
                document.getElementById('edit-masjid-country-ma').value = masjidDetails.country || '';
                document.getElementById('edit-masjid-latitude-ma').value = masjidDetails.latitude || '';
                document.getElementById('edit-masjid-longitude-ma').value = masjidDetails.longitude || '';
            } else {
                showMessage(errorMessage, `Could not load details for your bonded masjid (${currentUserMasjidId}).`, 'error');
            }

            if (prayerTimes) {
                // Populate Prayer Times Form for Masjid Admin
                document.getElementById('fajr-azan-ma').value = prayerTimes.FajrAzan || '';
                document.getElementById('fajr-prayer-ma').value = prayerTimes.FajrPrayer || '';
                document.getElementById('dhuhr-azan-ma').value = prayerTimes.DhuhrAzan || '';
                document.getElementById('dhuhr-prayer-ma').value = prayerTimes.DhuhrPrayer || '';
                document.getElementById('asr-azan-ma').value = prayerTimes.AsrAzan || '';
                document.getElementById('asr-prayer-ma').value = prayerTimes.AsrPrayer || '';
                document.getElementById('maghrib-azan-ma').value = prayerTimes.MaghribAzan || '';
                document.getElementById('maghrib-prayer-ma').value = prayerTimes.MaghribPrayer || '';
                document.getElementById('isha-azan-ma').value = prayerTimes.IshaAzan || '';
                document.getElementById('isha-prayer-ma').value = prayerTimes.IshaPrayer || '';
                document.getElementById('jumuah-azan-ma').value = prayerTimes.JumuahAzan || '';
                document.getElementById('jumuah-prayer-ma').value = prayerTimes.JumuahPrayer || '';
            } else {
                showMessage(errorMessage, `Could not load prayer times for your bonded masjid (${currentUserMasjidId}).`, 'error');
            }
        }

        // --- Event Handlers ---

        // Filter dropdown change listeners
        filterState.addEventListener('change', filterCities);
        filterCity.addEventListener('change', filterAreas);
        filterArea.addEventListener('change', filterMasjids);

        // Clear Filters button click
        clearFiltersBtn.addEventListener('click', () => {
            filterState.value = '';
            filterCity.value = '';
            filterCity.disabled = true;
            filterArea.value = '';
            filterArea.disabled = true;
            selectMasjidSuper.value = '';
            populateMasjidDatalist(allMasjidsData); // Show all masjids again
            clearAndHideMasjidForms(); // Clear and hide the details/prayer forms
            showMessage(successMessage, 'Filters cleared.');
        });


        // Handle selection from datalist (Super Admin) - Auto-load
        selectMasjidSuper.addEventListener('input', async () => {
            const selectedOption = Array.from(masjidListOptions.options).find(
                option => option.value === selectMasjidSuper.value
            );
            if (selectedOption) {
                selectedMasjidIdForEdit = selectedOption.dataset.masjidId;
                // Auto-load data when a valid selection is made
                showLoading();
                const masjidDetails = await fetchMasjidDetails(selectedMasjidIdForEdit);
                const prayerTimes = await fetchPrayerTimes(selectedMasjidIdForEdit);
                hideLoading();

                if (masjidDetails) {
                    masjidIdInput.value = masjidDetails.id || '';
                    document.getElementById('masjid-name').value = masjidDetails.name || '';
                    document.getElementById('masjid-contact').value = masjidDetails.contactNumber || '';
                    document.getElementById('masjid-email').value = masjidDetails.email || '';
                    document.getElementById('masjid-address').value = masjidDetails.address || '';
                    document.getElementById('masjid-area').value = masjidDetails.area || '';
                    document.getElementById('masjid-zipcode').value = masjidDetails.zipcode || '';
                    document.getElementById('masjid-city').value = masjidDetails.city || '';
                    document.getElementById('masjid-state').value = masjidDetails.state || ''; // Populate state input
                    document.getElementById('masjid-country').value = masjidDetails.country || '';
                    document.getElementById('masjid-latitude').value = masjidDetails.latitude || '';
                    document.getElementById('masjid-longitude').value = masjidDetails.longitude || '';
                    
                    toggleMasjidIdInput(false); // Make Masjid ID read-only when editing
                    masjidDetailsHeader.textContent = `Edit Masjid Details for ${masjidDetails.name}`;
                    showMessage(successMessage, `Data for ${masjidDetails.name} loaded successfully.`);
                } else {
                    masjidDetailsForm.reset();
                    toggleMasjidIdInput(true); // Make Masjid ID editable if not found
                    masjidDetailsHeader.textContent = 'Masjid Details';
                }

                if (prayerTimes) {
                    document.getElementById('fajr-azan').value = prayerTimes.FajrAzan || '';
                    document.getElementById('fajr-prayer').value = prayerTimes.FajrPrayer || '';
                    document.getElementById('dhuhr-azan').value = prayerTimes.DhuhrAzan || '';
                    document.getElementById('dhuhr-prayer').value = prayerTimes.DhuhrPrayer || '';
                    document.getElementById('asr-azan').value = prayerTimes.AsrAzan || '';
                    document.getElementById('asr-prayer').value = prayerTimes.AsrPrayer || '';
                    document.getElementById('maghrib-azan').value = prayerTimes.MaghribAzan || '';
                    document.getElementById('maghrib-prayer').value = prayerTimes.MaghribPrayer || '';
                    document.getElementById('isha-azan').value = prayerTimes.IshaAzan || '';
                    document.getElementById('isha-prayer').value = prayerTimes.IshaPrayer || '';
                    document.getElementById('jumuah-azan').value = prayerTimes.JumuahAzan || '';
                    document.getElementById('jumuah-prayer').value = prayerTimes.JumuahPrayer || '';
                } else {
                    prayerTimesForm.reset();
                }
                // Show the consolidated forms
                masjidDetailsSection.classList.remove('hidden');
                prayerTimesSection.classList.remove('hidden');
            } else {
                selectedMasjidIdForEdit = null; // No valid selection, reset
                clearAndHideMasjidForms();
            }
        });

        // Add New Masjid button click (Super Admin)
        addNewMasjidBtn.addEventListener('click', () => {
            clearAndHideMasjidForms(); // Clear and hide forms first
            toggleMasjidIdInput(true); // Ensure Masjid ID is editable
            masjidDetailsSection.classList.remove('hidden'); // Show details section
            prayerTimesSection.classList.remove('hidden'); // Show prayer times section
            masjidDetailsHeader.textContent = 'Add New Masjid Details'; // Update header
            selectMasjidSuper.value = ''; // Clear search/select input
            showMessage(successMessage, 'Ready to add a new masjid. Please fill in the details. Masjid ID will be auto-generated upon saving.');
        });

        // Consolidated Save All Changes button
        saveAllChangesBtn.addEventListener('click', async () => {
            hideAllMessages();
            showLoading();

            let masjidId = masjidIdInput.value.trim();
            const masjidName = document.getElementById('masjid-name').value.trim();
            const masjidCity = document.getElementById('masjid-city').value.trim();
            const masjidArea = document.getElementById('masjid-area').value.trim();
            const masjidState = document.getElementById('masjid-state').value.trim(); // Get state from input

            if (!masjidName || !masjidCity || !masjidArea || !masjidState) {
                showMessage(errorMessage, 'Masjid Name, City, State, and Area are required for saving.', 'error');
                hideLoading();
                return;
            }

            try {
                if (!selectedMasjidIdForEdit) { // Adding new masjid
                    // Auto-generate Masjid ID
                    const cityPart = masjidCity.substring(0, 3).toLowerCase();
                    const areaPart = masjidArea.substring(0, 3).toLowerCase();
                    const namePart = masjidName.replace(/\s+/g, '').toLowerCase();
                    masjidId = `${cityPart}-${areaPart}-${namePart}`;
                    masjidIdInput.value = masjidId; // Update the input field with the generated ID

                    const existingMasjid = await getDoc(doc(db, 'masjids', masjidId));
                    if (existingMasjid.exists()) {
                        showMessage(errorMessage, `Generated Masjid ID '${masjidId}' already exists. Please modify name/city/area or select existing.`, 'error');
                        hideLoading();
                        return;
                    }
                    
                    await setDoc(doc(db, 'masjids', masjidId), {
                        name: masjidName,
                        contactNumber: document.getElementById('masjid-contact').value.trim(),
                        email: document.getElementById('masjid-email').value.trim(),
                        address: document.getElementById('masjid-address').value.trim(),
                        area: masjidArea, // Use value from form input
                        zipcode: document.getElementById('masjid-zipcode').value.trim(),
                        city: masjidCity, // Use value from form input
                        state: masjidState, // Use value from form input
                        country: document.getElementById('masjid-country').value.trim(),
                        latitude: parseFloat(document.getElementById('masjid-latitude').value) || null,
                        longitude: parseFloat(document.getElementById('masjid-longitude').value) || null,
                    });
                    // Also create an empty prayerTimes document for the new masjid
                    await setDoc(doc(db, 'prayerTimes', masjidId), {
                        FajrAzan: "", FajrPrayer: "",
                        DhuhrAzan: "", DhuhrPrayer: "",
                        AsrAzan: "", AsrPrayer: "",
                        MaghribAzan: "", MaghribPrayer: "",
                        IshaAzan: "", IshaPrayer: "",
                        JumuahAzan: "", JumuahPrayer: ""
                    });
                    showMessage(successMessage, `Masjid '${masjidName}' added successfully!`);
                } else { // Editing existing masjid
                    await updateDoc(doc(db, 'masjids', masjidId), {
                        name: masjidName,
                        contactNumber: document.getElementById('masjid-contact').value.trim(),
                        email: document.getElementById('masjid-email').value.trim(),
                        address: document.getElementById('masjid-address').value.trim(),
                        area: masjidArea, // Use value from form input
                        zipcode: document.getElementById('masjid-zipcode').value.trim(),
                        city: masjidCity, // Use value from form input
                        state: masjidState, // Use value from form input
                        country: document.getElementById('masjid-country').value.trim(),
                        latitude: parseFloat(document.getElementById('masjid-latitude').value) || null,
                        longitude: parseFloat(document.getElementById('masjid-longitude').value) || null,
                    });
                    showMessage(successMessage, `Masjid '${masjidName}' details updated successfully!`);
                }

                // Save Prayer Times (always uses the masjidId from the input, which is now correct)
                await updateDoc(doc(db, 'prayerTimes', masjidId), {
                    FajrAzan: document.getElementById('fajr-azan').value,
                    FajrPrayer: document.getElementById('fajr-prayer').value,
                    DhuhrAzan: document.getElementById('dhuhr-azan').value,
                    DhuhrPrayer: document.getElementById('dhuhr-prayer').value,
                    AsrAzan: document.getElementById('asr-azan').value,
                    AsrPrayer: document.getElementById('asr-prayer').value,
                    MaghribAzan: document.getElementById('maghrib-azan').value,
                    MaghribPrayer: document.getElementById('maghrib-prayer').value,
                    IshaAzan: document.getElementById('isha-azan').value,
                    IshaPrayer: document.getElementById('isha-prayer').value,
                    JumuahAzan: document.getElementById('jumuah-azan').value,
                    JumuahPrayer: document.getElementById('jumuah-prayer').value,
                });
                showMessage(successMessage, 'All changes saved successfully!', 'success');
                await renderSuperAdminPanel(); // Re-populate dropdowns and reset forms
            } catch (error) {
                console.error("Error saving all changes:", error);
                showMessage(errorMessage, `Failed to save changes: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        // Masjid Admin Specific Form Submissions (IDs renamed)
        masjidAdminMasjidDetailsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            showLoading();
            const targetMasjidId = currentUserMasjidId; // Masjid Admin always edits their bonded masjid

            if (!targetMasjidId) {
                showMessage(errorMessage, 'Your admin account is not linked to a masjid.', 'error');
                hideLoading();
                return;
            }

            try {
                await updateDoc(doc(db, 'masjids', targetMasjidId), {
                    name: document.getElementById('edit-masjid-name-ma').value.trim(),
                    contactNumber: document.getElementById('edit-masjid-contact-ma').value.trim(),
                    email: document.getElementById('edit-masjid-email-ma').value.trim(),
                    address: document.getElementById('edit-masjid-address-ma').value.trim(),
                    area: document.getElementById('edit-masjid-area-ma').value.trim(),
                    zipcode: document.getElementById('edit-masjid-zipcode-ma').value.trim(),
                    city: document.getElementById('edit-masjid-city-ma').value.trim(),
                    state: document.getElementById('edit-masjid-state-ma').value.trim(), // Added state for masjid admin
                    country: document.getElementById('edit-masjid-country-ma').value.trim(),
                    latitude: parseFloat(document.getElementById('edit-masjid-latitude-ma').value) || null,
                    longitude: parseFloat(document.getElementById('edit-masjid-longitude-ma').value) || null,
                });
                showMessage(successMessage, 'Masjid details updated successfully!', 'success');
                await renderMasjidAdminPanel(); // Re-render to update name in header
            } catch (error) {
                console.error("Error updating masjid details for masjid admin:", error);
                showMessage(errorMessage, `Failed to update masjid details: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        masjidAdminPrayerTimesForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            showLoading();
            const targetMasjidId = currentUserMasjidId; // Masjid Admin always edits their bonded masjid

            if (!targetMasjidId) {
                showMessage(errorMessage, 'Your admin account is not linked to a masjid.', 'error');
                hideLoading();
                return;
            }

            try {
                await updateDoc(doc(db, 'prayerTimes', targetMasjidId), {
                    FajrAzan: document.getElementById('fajr-azan-ma').value,
                    FajrPrayer: document.getElementById('fajr-prayer-ma').value,
                    DhuhrAzan: document.getElementById('dhuhr-azan-ma').value,
                    DhuhrPrayer: document.getElementById('dhuhr-prayer-ma').value,
                    AsrAzan: document.getElementById('asr-azan-ma').value,
                    AsrPrayer: document.getElementById('asr-prayer-ma').value,
                    MaghribAzan: document.getElementById('maghrib-azan-ma').value,
                    MaghribPrayer: document.getElementById('maghrib-prayer-ma').value,
                    IshaAzan: document.getElementById('isha-azan-ma').value,
                    IshaPrayer: document.getElementById('isha-prayer-ma').value,
                    JumuahAzan: document.getElementById('jumuah-azan-ma').value,
                    JumuahPrayer: document.getElementById('jumuah-prayer-ma').value,
                });
                showMessage(successMessage, 'Prayer times updated successfully!', 'success');
            } catch (error) {
                console.error("Error updating prayer times for masjid admin:", error);
                showMessage(errorMessage, `Failed to update prayer times: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });


        // Logout functionality
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'login.html'; // Redirect to login page after logout
            } catch (error) {
                console.error('Error logging out:', error);
                showMessage(errorMessage, 'Logout failed: ' + error.message, 'error');
            }
        });

        // --- Initialization and Auth State Listener ---
        onAuthStateChanged(auth, async (user) => {
            hideAllMessages();
            if (user) {
                showLoading();
                await fetchUserRoleAndMasjidId(user.uid);

                if (currentUserRole === 'superAdmin') {
                    renderSuperAdminPanel();
                } else if (currentUserRole === 'masjidAdmin') {
                    renderMasjidAdminPanel();
                } else {
                    permissionDeniedMessage.classList.remove('hidden');
                    hideLoading();
                }
            } else {
                authStatusMessage.classList.remove('hidden');
                superAdminPanel.classList.add('hidden');
                masjidAdminPanel.classList.add('hidden');
                hideLoading();
            }
        });
    </script>
</body>
</html>
